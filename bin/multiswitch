#!/bin/bash
#/////////////////////////////////////////////////////////////////////////////////////
# Multiswitch for NanoHome - multi-toggle devices
#/////////////////////////////////////////////////////////////////////////////////////

# Catch Parameters
dev1="$2"
dev2="$3"
value1="toggle"
value2="toggle"
rec="$4"
if [ "$rec" = "Aktiv..." ]; then rec="always"; fi
from="$5"
to="$6"
rootpath="INSTALLDIR"

# Exit If
if [ "$dev1" = "Wenn..." ] || [ "$dev2" = "Dann..." ]; then exit 1; fi

# Device Support
if [ ! "$1" = "remove" ] && [ ! "$dev1" = "all" ]; then
	. $rootpath/dev_compatibility $dev1
fi

# Environment
service_line="multiswitchsvc $dev1 $dev2 $value1 $value2"
desc1="$(cat $rootpath/devlist | grep $dev1 | cut -d: -f2 )"
desc2="$(cat $rootpath/devlist | grep $dev2 | cut -d: -f2 )"

#/////////////////////////////////////////////////////////////////////////////////////
# Show Multiswitches
#/////////////////////////////////////////////////////////////////////////////////////
if [ "$1" = "show" ] && [ ! -z "$dev1" ]; then

	ms="$(grep multiswitchsvc $rootpath/driver/nanohome_helper)"
	
	# show active state of device
	if [ "$dev1" = "$dev2" ] || [ "$dev1" = "all" ] && [ ! -z "$ms" ]; then
	
		statusmsg "Multiswitch" "white" " aktiv" "#c0fcb1" "$ms" "hotpink"
	
	elif grep "$service_line" $rootpath/driver/nanohome_helper ; then
		
		statusmsg "Multiswitch" "white" " aktiv" "#c0fcb1" "$desc1 -> $desc2" "hotpink"
		
	else

		statusmsg "Multiswitch" "white" " inaktiv" "grey" "Kein Multiswitch aktiv" "grey"

	fi


#/////////////////////////////////////////////////////////////////////////////////////
# Add Multiswitch
#/////////////////////////////////////////////////////////////////////////////////////
elif [ "$1" = "add" ] && [ ! -z "$dev1" ] && [ ! -z "$dev2" ] && [ ! "$dev1" = "$dev2" ]; then
	
	if grep "$service_line" $rootpath/driver/nanohome_helper ; then
	
		statusmsg "Multiswitch" "white" "$desc1 -> $desc2" "hotpink" "Multiswitch exists" "white"
		exit 1
		
	else
	
		echo "$service_line" >> $rootpath/driver/nanohome_helper
		systemctl restart nanohome_helper
		statusmsg "Multiswitch" "white" " aktiviert" "#c0fcb1" "$desc1 -> $desc2" "hotpink"

	fi

#/////////////////////////////////////////////////////////////////////////////////////
# Remove Multiswitch
#/////////////////////////////////////////////////////////////////////////////////////
elif [ "$1" = "remove" ] && [ ! -z "$dev1" ] && [ ! "$dev1" = "$dev2" ]; then

	# remove all services if only one device is set
	if [ "$dev2" == "" ]; then 
		sed -i "/$dev2/d" $rootpath/driver/nanohome_helper
		systemctl restart nanohome_helper
		statusmsg "Multiswitch" "white" " deaktiviert" "grey" "für $desc1" "hotpink"
	else
		sed -i "/$service_line/d" $rootpath/driver/nanohome_helper
		systemctl restart nanohome_helper
		statusmsg "Multiswitch" "white" " deaktiviert" "grey" "$desc1 -> $desc2" "hotpink"
	fi
	
	

else

	statusmsg "Error" "red" "" "" "Eingabe prüfen" "white"

	exit 1

fi

